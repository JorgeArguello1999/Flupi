<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
    <link rel="stylesheet" href="{{ url_for('configs.static', filename='style_chat_pop.css') }}">
</head>
<body>
    <!-- Botón de apertura del chat -->
    <div id="chat-open-btn">Abrir Chat</div>

    <!-- Cuadro de diálogo emergente -->
    <div id="chat-popup">
        <div id="chat-container" class="container_chat">
            <div id="chat-messages" class="chat-box">
                <!-- Aquí se mostrarán los mensajes de la conversación -->
            </div>
            <form id="chat-form" class="chat-input">
                <input type="text" id="message-input" class="form-control" placeholder="Escribe un mensaje...">
                <button type="submit" class="btn btn-outline-primary">Enviar</button>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

    <script>
        $(document).ready(function() {
            // Elementos del chat
            const chatOpenBtn = $('#chat-open-btn');
            const chatPopup = $('#chat-popup');
            const chatMessages = $('#chat-messages');
            const chatForm = $('#chat-form');
            const messageInput = $('#message-input');

            // Mostrar el cuadro de diálogo emergente al hacer clic en el botón de apertura
            chatOpenBtn.click(function() {
                chatPopup.toggle();
                scrollToBottom();
            });

            // Función para desplazarse hacia abajo en el contenedor de mensajes
            function scrollToBottom() {
                chatMessages.animate({ scrollTop: chatMessages.prop('scrollHeight') }, 300);
            }

            // Función para mostrar un mensaje en el chat
            function showMessage(message, isUser, image, time) {
                const sender = isUser ? 'Tú' : 'Chatbot';
                const cssClass = isUser ? 'message-user' : 'message-bot';
                const messageDiv = `
                    <div class="${cssClass}">
                        <img src="data:image/png;base64,${image}" class="img_profile" />
                        <p>${message}</p>
                        <span class="message-time">${time}</span>
                    </div>`;
                chatMessages.append(messageDiv);
                scrollToBottom();
            }

            // Script original adaptado
            var apiUrl = window.location.origin;
            apiUrl = apiUrl + '/api/';
            console.log(apiUrl);

            // Intercepta el envío del formulario
            chatForm.submit(function(event) {
                event.preventDefault();
                const userMessage = messageInput.val();
                const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "ask": userMessage,
                        "user": "Bot",
                        "device": "computer",
                        "token": "97293a31-9100-4f8f-8647-64856d1e2101"
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Manejar la respuesta de la API
                    showMessage(userMessage, true, data.photo_user, currentTime); // Mostrar la foto del usuario después de su mensaje
                    showMessage(data.response, false, data.photo_role, currentTime); // Mostrar la respuesta del chatbot después del mensaje del usuario
                })
                .catch(error => {
                    console.error('Error:', error);
                });

                messageInput.val("");
            });
        });
    </script>
</body>
</html>