{% extends 'base.html' %}

{% block title %} Chat {% endblock %}
{% block subtitle %} Chat {% endblock %}

{% block content %}

<style>
    /* Estilos adicionales para los mensajes */
    .message-user {
        color: #007bff;
        text-align: right;
        margin-bottom: 10px;

        background-color: #bcf0f7;
        border-radius: 10px;
        border-style: solid;
        border: 3px;
        padding: 1em;
        margin-left: 20%;
    }
    .message-bot {
        color: #28a745;
        text-align: left;
        margin-bottom: 10px;
        
        background-color: #bcf089;
        border-radius: 10px;
        border-style: solid;
        border: 3px;
        padding: 1em;
        margin-right: 20%;
    }
</style>

<div class="container py-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div id="chat-container">
                <div id="chat-messages" class="mb-4">
                    <!-- Aquí se mostrarán los mensajes de la conversación -->
                </div>
                <form id="chat-form" class="fixed-bottom mb-4">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Escribe un mensaje...">
                        <button type="submit" class="btn btn-outline-primary">✈️</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Función para mostrar un mensaje en el chat
        function showMessage(message, isUser) {
            const sender = isUser ? 'Tú' : 'Chatbot';
            const cssClass = isUser ? 'message-user' : 'message-bot';
            const messageDiv = `<div class="${cssClass}">${message}</div>`;
            $("#chat-messages").prepend(messageDiv); // Agregar mensaje al principio

            // Desplazar hacia abajo para ver el mensaje más reciente
            $("#chat-container").scrollTop(0);
        }

        // Manejar el envío del formulario
        $("#chat-form").submit(function(event) {
            event.preventDefault();
            const userMessage = $("#message-input").val();
            showMessage(userMessage, true);

            // Enviar el mensaje al servidor y recibir una respuesta
            $.ajax({
                type: "POST",
                url: "/chatbot/",
                data: JSON.stringify({ "ask": userMessage, "device": "computer" }),
                contentType: "application/json",
                dataType: "text",
                success: function(data) {
                    showMessage(data, false);
                }
            });

            $("#message-input").val(""); // Limpiar el campo de entrada
        });

        // Mantener el foco en el campo de texto
        $("#message-input").focus();

        // Permitir desplazarse por el chat usando la rueda del mouse
        $("#chat-container").on("wheel", function(event) {
            const delta = event.originalEvent.deltaY;
            $(this).scrollTop($(this).scrollTop() - delta);
            event.preventDefault();
        });
    });
</script>

{% endblock %}
